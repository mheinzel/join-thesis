\section{\CoreJoinCalc to \ActorPiCalc}

\subsection{A Naive Approach}

The simple translation of \joincalc into \asyncpicalc
\cite{fournet_reflexive_1996}
cannot be re-used for the translation to \actorpicalc,
since it does not adhere to its typing rules.

\begin{align*}
  \encMJtoAP{P \jpar Q}
  &= \encMJtoAP{P} \apar \encMJtoAP{Q}
  \\
  \encMJtoAP{\jsnd{x}{y}}
  &= \asnd{x}{y}
  \\
  \encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{Q}}
  &= \anew{x}{\anew{y}{\parens{\ains{B}{x, y}{\tilde{z}} \apar \encMJtoAP{Q}}}}
  \\
  \text{with }
  \adef*{B}{x,y}{\tilde{z}}{\arcv{x}{u} . \arcv{y}{v} . \parens{\ains{B}{x, y}{\tilde{z}} \apar \encMJtoAP{P}}}
  \\
  \tilde{z}
  &= \fn{P} \setminus {\{u, v\}}
\end{align*}

Note that if $\fn{P}$ contains $x$ or $y$,
we have to prevent conflicts by applying a renaming to $P$.

\TODO{3cm}{typing derivation?}


\subsection{Forwarding}

\TODO{2cm}{reason: actor cannot receive on two channels interchangeably}

\TODO{2cm}{idea: sending both $x$ and $y$ to same actor}

\begin{align*}
  \adef*{B_{fw}}{x}{a}{\arcv{x}{i} . \parens{\asnd{a}{x,i} \apar \ains{B_{fw}}{x}{a}}}
\end{align*}

\subsection{Storing Payloads}

\TODO{3cm}{problem: can receive $x$ and $y$ in arbitrary order\\
  receive two $x$s, need to respawn\\
  introduces divergence\\
  we need some storage}

We can use church-encoding to build lists from actors and avoid divergence.

\TODO{2cm}{explain church-encoding\\
  (persistent)}

\begin{align*}
  \adef*{B_{nil}}{l}{}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_n}{} \apar \ains{B_{nil}}{l}{}}}
  \\
  \adef*{B_{cons}}{l}{h,t}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_c}{h,t} \apar \ains{B_{cons}}{l}{h,t}}}
\end{align*}

The actor now receives forwarded messages from both channels $x$ and $y$.
If it receives more messages from one of these channels than from the other,
it stores the excess payloads in a list and remembers from which channel
these came (as there can only be excessive messages on one of these channels).
We again make sure the free names in $P$ do not conflict with any of the names
$a$, $x$, $y$, $f$, $l$, $c$, $p$, $k_n$, $k_c$, $k_P$ and $k_a$,
and define $\tilde{z}$
as the tuple of names in $\fn{P} \setminus {\{u, v\}}$
to give following behavior for the actor.

\begin{align*}
  \adef*{B_a^P}{a}{x,y,f,l,\tilde{z}}{\arcv{a}{c,p} . \anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{
    \\
    &\hspace{1cm}
    \begin{aligned}[t]
      \big(\ &\asnd{l}{k_n,k_c}
      \\
      \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}}}
      \\
      \apar  &\arcv{k_c}{h,t} .
        \begin{aligned}[t]
          \acse*{c}{
          \ &\aalt{f}{\anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{f, l'}}}}, \\
            &\aalt{x}{\asnd{k_P}{p,h} \apar \asnd{k_a}{f,t}}, \\
            &\aalt{y}{\asnd{k_P}{h,p} \apar \asnd{k_a}{f,t}}
          \ }
        \end{aligned}
      \\
      \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
      \\
      \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}}
      \ \big)
    \end{aligned}
  }}}}} \\
\end{align*}

To encode a \joincalc definition,
we now start one such joining actor (with initially no excess payloads),
a forwarder for each channel
and the encoded subprocess in which the definition is available.

\begin{align*}
  \encMJtoAP{P \jpar Q}
  &= \encMJtoAP{P} \apar \encMJtoAP{Q}
  \\
  \encMJtoAP{\jsnd{x}{y}}
  &= \asnd{x}{y}
  \\
  \encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{Q}}
  &= \anew{a}{\anew{x}{\anew{y}{\anew{l}{
    \begin{aligned}[t]
      \big(\ &\ains{B_a^P}{a}{x, y, x, l} \\
      \apar  &\ains{B_{fw}}{x}{a} \apar \ains{B_{fw}}{y}{a} \\
      \apar  &\ains{B_{nil}}{l}{} \\
      \apar  &\encMJtoAP{Q}
      \ \big)
    \end{aligned}
  }}}}
\end{align*}

\TODO{4cm}{type correctness\\
  $\judgement{}{}{\encMJtoAP{P}}$ for all core join terms $P$ (by structural induction)\\
  then check type correctness of definitions}

\begin{align*}
  &\encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{\jsnd{x}{b} \jpar \jsnd{y}{c} \jpar Q}}
  \\ &\hspace{0.5cm}
  \begin{aligned}[t]
    =\ &
    \anew{a}{\anew{x}{\anew{y}{\anew{l}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\ains{B_{fw}}{x}{a}
        \apar   \ains{B_{fw}}{y}{a} \\
        \apar  &\asnd{x}{b} \apar \asnd{y}{c} \apar \encMJtoAP{Q} \\
        \apar  &\ains{B_{nil}}{l}{}
        \apar   \ains{B_a^P}{a}{x, y, x, l}
        \ \big)
      \end{aligned}
    }}}}
    \\
    \apireduction{}^*\ & % PAR, BEHV, INP, ...
    \anew{a}{\anew{x}{\anew{y}{\anew{l}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\ains{B_{fw}}{x}{a}
        \apar   \ains{B_{fw}}{y}{a} \\
        \apar  &\asnd{a}{x,b} \apar \asnd{a}{y,c} \apar \encMJtoAP{Q} \\
        \apar  &\ains{B_{nil}}{l}{}
        \apar   \ains{B_a^P}{a}{x, y, x, l}
        \ \big)
      \end{aligned}
    }}}}
    \\
    \apireduction{}^*\ & % BEHV for B_a, pulling out news
    \anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\ains{B_{fw}}{x}{a}
        \apar   \ains{B_{fw}}{y}{a} \\
        \apar  &\asnd{a}{y,c} \apar \encMJtoAP{Q} \\
        \apar  &\ains{B_{nil}}{l}{} \\
        \apar  &\asnd{l}{k_n,k_c} \\
        \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}}} \\
        \apar  &\arcv{k_c}{h,t} .
          \begin{aligned}[t]
            \acse*{c}{
            \ &\aalt{x}{\anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{x, l'}}}}, \\
              &\aalt{x}{\asnd{k_P}{p,h} \apar \asnd{k_a}{x,t}}, \\
              &\aalt{y}{\asnd{k_P}{h,p} \apar \asnd{k_a}{x,t}}
            \ }
          \end{aligned} \\
        \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P} \\
        \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}}
        \ \big)
      \end{aligned}
    }}}}}}}}
    \\
    \apireduction{}^*\ & % BEHV B_nil
    \anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\ains{B_{fw}}{x}{a}
        \apar   \ains{B_{fw}}{y}{a} \\
        \apar  &\asnd{a}{y,c} \apar \encMJtoAP{Q} \\
        \apar  &\asnd{k_n}{} \apar \ains{B_{nil}}{l}{} \\
        \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}}} \\
        \apar  &\arcv{k_c}{h,t} .
          \begin{aligned}[t]
            \acse*{c}{
            \ &\aalt{x}{\anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{x, l'}}}}, \\
              &\aalt{x}{\asnd{k_P}{p,h} \apar \asnd{k_a}{x,t}}, \\
              &\aalt{y}{\asnd{k_P}{h,p} \apar \asnd{k_a}{x,t}}
            \ }
          \end{aligned} \\
        \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P} \\
        \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}}
        \ \big)
      \end{aligned}
    }}}}}}}}
    \\
    \apireduction{}^*\ & % send k_n, dropping k_c branch, dropping k_P
    \anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\asnd{a}{x,b} \apar \ains{B_{fw}}{x}{a} \\
        \apar  &\asnd{a}{y,c} \apar \ains{B_{fw}}{y}{a} \\
        \apar  &\ains{B_{nil}}{l}{} \\
        \apar  &\encMJtoAP{Q} \\
        \apar  &\anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}}} \\
        \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}}
        \ \big)
      \end{aligned}
    }}}}}}}}
    \\
    \apireduction{}^*\ &
    \anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{\anew{l'}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\asnd{a}{x,b} \apar \ains{B_{fw}}{x}{a} \\
        \apar  &\asnd{a}{y,c} \apar \ains{B_{fw}}{y}{a} \\
        \apar  &\ains{B_{nil}}{l}{} \\
        \apar  &\encMJtoAP{Q} \\
        \apar  &\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}} \\
        \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}}
        \ \big)
      \end{aligned}
    }}}}}}}}}
  \end{aligned}
\end{align*}

\TODO{4cm}{"operational correspondence"}


\subsection{Full Abstraction}

\TODO{3cm}{join-pi encodings require firewall for full abstraction\\
  (explain why by example?)\\
  this is not necessary here, because ...}
