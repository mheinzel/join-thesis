\section{\CoreJoinCalc to \ActorPiCalc}

\subsection{A Naive Approach}

The simple translation of \joincalc into \asyncpicalc
\cite{fournet_reflexive_1996}
cannot be re-used for the translation to \actorpicalc,
since it does not adhere to its typing rules.

For the remainder of this chapter, we define
$\tilde{z}_P$
as the tuple of names in
$\fn{P} \setminus {\{x, y, u, v\}}$.
This is necessary since $P$ might have free names
that are now also free in the definition of $B$ and thus
have to be bound in the parameter list.

\begin{align*}
  \encMJtoAP{P \jpar Q}
  &= \encMJtoAP{P} \apar \encMJtoAP{Q}
  \\
  \encMJtoAP{\jsnd{x}{y}}
  &= \asnd{x}{y}
  \\
  \encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{Q}}
  &= \anew{x}{\anew{y}{\parens{\ains{B}{x, y}{\tilde{z}} \apar \encMJtoAP{Q}}}}
  \\
  \text{with }
  \adef*{B}{x,y}{\tilde{z}}{\arcv{x}{u} . \arcv{y}{v} . \parens{\ains{B}{x, y}{\tilde{z}} \apar \encMJtoAP{P}}}
  \\
\end{align*}

\TODO{3cm}{typing derivation?}


\subsection{Forwarding}

\TODO{2cm}{reason: actor cannot receive on two channels interchangeably}

\TODO{2cm}{idea: sending both $x$ and $y$ to same actor}

\begin{align*}
  \adef*{B_{fw}}{x}{a}{\arcv{x}{i} . \parens{\asnd{a}{x,i} \apar \ains{B_{fw}}{x}{a}}}
\end{align*}

\subsection{Storing Payloads}

\TODO{3cm}{problem: can receive $x$ and $y$ in arbitrary order\\
  receive two $x$s, need to respawn\\
  introduces divergence\\
  we need some storage}

We can use church-encoding to build lists from actors and avoid divergence.

\TODO{2cm}{explain church-encoding\\
  (persistent)}

\begin{align*}
  \adef*{B_{nil}}{l}{}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_n}{} \apar \ains{B_{nil}}{l}{}}}
  \\
  \adef*{B_{cons}}{l}{h,t}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_c}{h,t} \apar \ains{B_{cons}}{l}{h,t}}}
\end{align*}

The actor can now receive forwarded messages from both channels $x$ and $y$.
If it receives more messages from one of these channels than from the other,
it stores the excess payloads in a list $l$ and remembers from which channel
these came using a flag $f$.
This is possible since there can always only be excessive messages on one of these channels;
otherwise they would have been joined already.
We have to make sure the free names in $P$ do not conflict with any of the names
$a$, $f$, $l$, $c$, $p$, $k_n$, $k_c$, $k_P$ and $k_a$
to give following behavior for the actor.

\begin{align*}
  \adef*{B_a^P}{a}{x,y,f,l,\tilde{z}_P}{\arcv{a}{c,p} . \anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{
    \\
    &\hspace{1cm}
    \begin{aligned}[t]
      \big(\ &\asnd{l}{k_n,k_c}
      \\
      \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}}}
      \\
      \apar  &\arcv{k_c}{h,t} .
        \begin{aligned}[t]
          \acse*{f}{\ 
            &\aalt{x}{
              \begin{aligned}[t]
                \acse*{c}{\ 
                  &\aalt{x}{\anew*{l'}{
                    \ains{B_{cons}}{l'}{p,l} \apar \asnd{k_a}{f,l'}
                  }}\\
                  &\aalt{y}{
                    \asnd{k_P}{h,p} \apar \asnd{k_a}{f,t}
                  }\ 
                }
              \end{aligned}
            }\\
            &\aalt{y}{
              \begin{aligned}[t]
                \acse*{c}{\ 
                  &\aalt{y}{\anew*{l'}{
                    \ains{B_{cons}}{l'}{p,l} \apar \asnd{k_a}{f,l'}
                  }}\\
                  &\aalt{x}{
                    \asnd{k_P}{p,h} \apar \asnd{k_a}{f,t}
                  }\ 
                }
              \end{aligned}
            }\ 
          }
        \end{aligned}
      \\
      \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
      \\
      \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}_P}
      \ \big)
    \end{aligned}
  }}}}} \\
\end{align*}

To encode a \joincalc definition,
we now start one such joining actor (with initially no excess payloads),
a forwarder for each channel
and the encoded subprocess in which the definition is available.

\begin{align*}
  \encMJtoAP{P \jpar Q}
  &= \encMJtoAP{P} \apar \encMJtoAP{Q}
  \\
  \encMJtoAP{\jsnd{x}{y}}
  &= \asnd{x}{y}
  \\
  \encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{Q}}
  &= \anew{a}{\anew{x}{\anew{y}{\anew{l}{
    \begin{aligned}[t]
      \big(\ &\ains{B_a^P}{a}{x, y, x, l, \tilde{z}_P} \\
      \apar  &\ains{B_{fw}}{x}{a} \apar \ains{B_{fw}}{y}{a} \\
      \apar  &\ains{B_{nil}}{l}{} \\
      \apar  &\encMJtoAP{Q}
      \ \big)
    \end{aligned}
  }}}}
\end{align*}


\begin{theorem}
  \label{enctypecorrect}
  $\judgement{}{}{\encMJtoAP{J}}$ for all terms $J$ in \corejoincalc
\end{theorem}

\begin{proof}
  We prove the theorem by structural induction over the grammar of \corejoincalc.
  Let $x, y \in \mathcal{N}$ and $J$ any term in \corejoincalc.

  \begin{case}
    $J = \jsnd{x}{y}$.
    \\
    Then $\encMJtoAP{J} = \asnd{x}{y}$
    and thus $\judgement{}{}{\encMJtoAP{J}}$
    by \rulename{msg}.
  \end{case}

  \begin{case}
    $J = P \jpar Q$
    with $\judgement{}{}{\encMJtoAP{P}}$ and $\judgement{}{}{\encMJtoAP{Q}}$.
    \\
    Then $\encMJtoAP{P \jpar Q} = \encMJtoAP{P} \apar \encMJtoAP{Q}$
    and thus $\judgement{}{}{\encMJtoAP{J}}$
    by \rulename{comp}.
  \end{case}

  \begin{case}
    $J = \jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{Q}$
    with $\judgement{}{}{\encMJtoAP{P}}$ and $\judgement{}{}{\encMJtoAP{Q}}$.
    \begin{align*}
      \encMJtoAP{J} = \anew{a}{\anew{x}{\anew{y}{\anew{l}{
        \underbrace{
          \left( \ains{B_a^P}{a}{x, y, x, l, \tilde{z}_P}
          \apar  \ains{B_{fw}}{x}{a} \apar \ains{B_{fw}}{y}{a}
          \apar  \ains{B_{nil}}{l}{}
          \apar  \encMJtoAP{Q}
          \right)
        }_{R}
      }}}}
    \end{align*}
    Then $\judgement{\{a,x,y,l\}}{f}{R}$ with $f(a) = f(x) = f(y) = f(l) = \bot$
    and
    $\judgement{}{}{\encMJtoAP{J}}$.
    Also, all used definitions have to be well-typed.
    \begin{align*}
      \adef*{B_{fw}}{x}{a}{\arcv{x}{i} . \parens{\asnd{a}{x,i} \apar \ains{B_{fw}}{x}{a}}}
      &\judgement*{\{x\}}{\ch{x}}{\arcv{x}{i} . \parens{\asnd{a}{x,i} \apar \ains{B_{fw}}{x}{a}}}
      \\
      \adef*{B_{nil}}{l}{}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_n}{} \apar \ains{B_{nil}}{l}{}}}
      &\judgement*{\{l\}}{\ch{l}}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_n}{} \apar \ains{B_{nil}}{l}{}}}
      \\
      \adef*{B_{cons}}{l}{h,t}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_c}{h,t} \apar \ains{B_{cons}}{l}{h,t}}}
      &\judgement*{\{l\}}{\ch{l}}{\arcv{l}{k_n,k_c} . \parens{\asnd{k_c}{h,t} \apar \ains{B_{cons}}{l}{h,t}}}
    \end{align*}
    \begin{align*}
      \adef*{B_a^P}{a}{x,y,f,l,\tilde{z}_P}{\arcv{a}{c,p} . \anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{
        \\
        &\hspace{1cm}
        R \left\lbrace
        \begin{aligned}[c]
          \big(\ &\asnd{l}{k_n,k_c}
          \\
          \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{p, l} \apar \asnd{k_a}{c, l'}}}
          \\
          \apar  &\arcv{k_c}{h,t} .
            \begin{aligned}[t]
              \acse*{f}{\ 
                &\aalt{x}{
                  \begin{aligned}[t]
                    \acse*{c}{\ 
                      &\aalt{x}{\anew*{l'}{
                        \ains{B_{cons}}{l'}{p,l} \apar \asnd{k_a}{f,l'}
                      }}\\
                      &\aalt{y}{
                        \asnd{k_P}{h,p} \apar \asnd{k_a}{f,t}
                      }\ 
                    }
                  \end{aligned}
                }\\
                &\aalt{y}{
                  \begin{aligned}[t]
                    \acse*{c}{\ 
                      &\aalt{y}{\anew*{l'}{
                        \ains{B_{cons}}{l'}{p,l} \apar \asnd{k_a}{f,l'}
                      }}\\
                      &\aalt{x}{
                        \asnd{k_P}{p,h} \apar \asnd{k_a}{f,t}
                      }\ 
                    }
                  \end{aligned}
                }\ 
              }
            \end{aligned}
          \\
          \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
          \\
          \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}_P}
          \ \big)
        \end{aligned}
        \right.
      }}}}}
    \end{align*}

    Since none of the branches in the nested case-term have any recipients
    and the last line has type $\ch{k_a,a}$,
    we can derive:
    \begin{align*}
      \judgement*{\{k_n,k_c,k_P,k_a,a\}}{g}{R}
      \text{ \ with }
      g(k_n) = g(k_c) = g(k_P) = g(a) = \bot, g(k_a) = a
      \\
      \judgement*{\{a\}}{\ch{a}}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{R}}}}}
      \\
      \judgement*{\{a\}}{\ch{a}}{\arcv{a}{c,p} . \anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{R}}}}}
    \end{align*}
  \end{case}
\end{proof}


\TODO{2cm}{step through \actorpicalc reductions corresponding to single step in \joincalc}

\begin{align*}
  \jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{\jsnd{x}{b} \jpar \jsnd{y}{c} \jpar Q}
  \joinreduction
  \jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{P\substitution{\subst{b}{u},\subst{c}{v}} \jpar Q}
\end{align*}

Looking at a series of reductions:

\begin{align*}
  \encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{\jsnd{x}{b} \jpar \jsnd{y}{c} \jpar Q}}
  =\ &\anew{a}{\anew{x}{\anew{y}{\anew{l}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\ains{B_{fw}}{x}{a}
        \apar   \ains{B_{fw}}{y}{a} \\
        \apar  &\asnd{x}{b} \apar \asnd{y}{c} \apar \encMJtoAP{Q} \\
        \apar  &\ains{B_{nil}}{l}{}
        \apar   \ains{B_a^P}{a}{x, y, x, l, \tilde{z}_P}
        \ \big)
      \end{aligned}
    }}}}
\end{align*}

\TODO{1cm}{forward on x and y}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\asnd{a}{x,b}
      \apar   \ains{B_{fw}}{x}{a}
      \apar   \asnd{a}{y,c}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q} \\
      \apar  &\ains{B_{nil}}{l}{}
      \apar   \ains{B_a^P}{a}{x, y, x, l, \tilde{z}_P}
      \ \big)
    \end{aligned}
  }}}}
\end{align*}

\TODO{1cm}{receive x in $B_a^P$ (symmetry)}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \asnd{a}{y,c}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \asnd{l}{k_n,k_c}
      \\
      \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{b, l} \apar \asnd{k_a}{x, l'}}}
      \\
      \apar  &\arcv{k_c}{h,t} .
        \begin{aligned}[t]
          \acse*{f}{\ 
            &\aalt{x}{
              \begin{aligned}[t]
                \acse*{x}{\ 
                  &\aalt{x}{\anew*{l'}{
                    \ains{B_{cons}}{l'}{b,l} \apar \asnd{k_a}{f,l'}
                  }}\\
                  &\aalt{y}{
                    \asnd{k_P}{h,b} \apar \asnd{k_a}{f,t}
                  }\ 
                }
              \end{aligned}
            }\\
            &\aalt{y}{
              \begin{aligned}[t]
                \acse*{x}{\ 
                  &\aalt{y}{\anew*{l'}{
                    \ains{B_{cons}}{l'}{b,l} \apar \asnd{k_a}{f,l'}
                  }}\\
                  &\aalt{x}{
                    \asnd{k_P}{b,h} \apar \asnd{k_a}{f,t}
                  }\ 
                }
              \end{aligned}
            }\ 
          }
        \end{aligned}
      \\
      \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
      \\
      \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}_P}
      \ \big)
    \end{aligned}
  }}}}}}}}
\end{align*}

\TODO{1cm}{$B_{nil}$ receives continuations\\
  (can put $k_c$ and $k_P$ in garbage)}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_n}{\anew{k_a}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \asnd{a}{y,c}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \asnd{k_n}{}
      \apar   \ains{B_{nil}}{l}{}
      \\
      \apar  &\arcv{k_n}{} . \anew{l'}{\parens{\ains{B_{cons}}{l'}{b, l} \apar \asnd{k_a}{x, l'}}}
      \\
      \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}_P}
      \\
      \apar  &R_{garbage}
      \ \big)
    \end{aligned}
  }}}}}}
\end{align*}

\TODO{1cm}{$k_n$, pull out scope of $l'$}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{k_a}{\anew{l'}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \asnd{a}{y,c}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \\
      \apar  &\ains{B_{cons}}{l'}{b, l}
      \apar   \asnd{k_a}{x, l'}
      \\
      \apar  &\arcv{k_a}{f',l'} . \ains{B_a^P}{a}{x, y, f', l',\tilde{z}_P}
      \\
      \apar  &R_{garbage}
      \ \big)
    \end{aligned}
  }}}}}}
\end{align*}

\TODO{1cm}{$k_a$, scope can be removed:
  $ \anew{k_a}{S}
    \astructequ \anew*{k_a}{S \apar \anullproc}
    \astructequ S \apar \anew{k_a}{\anullproc}
    \astructequ S \apar \anullproc
    \astructequ S $}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{l'}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \asnd{a}{y,c}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \ains{B_{cons}}{l'}{b, l}
      \\
      \apar  &\ains{B_a^P}{a}{x, y, x, l',\tilde{z}_P}
      \\
      \apar  &R_{garbage}
      \ \big)
    \end{aligned}
  }}}}}
\end{align*}

\TODO{2cm}{same situation as before, but $\asnd{a}{x,b}$ gone, $b$ stored in list $l'$, garbage.\\
  now receive the $y$ (alpha-renaming $l'$)}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{l'}{\anew{k_n}{\anew{k_c}{\anew{k_P}{\anew{k_a}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \ains{B_{cons}}{l'}{b, l}
      \\
      \apar  &\asnd{l'}{k_n,k_c}
      \\
      \apar  &\arcv{k_n}{} . \anew{l''}{\parens{\ains{B_{cons}}{l''}{c, l'} \apar \asnd{k_a}{y, l''}}}
      \\
      \apar  &\arcv{k_c}{h,t} .
        \begin{aligned}[t]
          \acse*{x}{\ 
            &\aalt{x}{
              \begin{aligned}[t]
                \acse*{y}{\ 
                  &\aalt{x}{\anew*{l''}{
                    \ains{B_{cons}}{l''}{c,l'} \apar \asnd{k_a}{x,l''}
                  }}\\
                  &\aalt{y}{
                    \asnd{k_P}{h,c} \apar \asnd{k_a}{x,t}
                  }\ 
                }
              \end{aligned}
            }\\
            &\aalt{y}{
              \begin{aligned}[t]
                \acse*{y}{\ 
                  &\aalt{y}{\anew*{l''}{
                    \ains{B_{cons}}{l''}{c,l'} \apar \asnd{k_a}{x,l''}
                  }}\\
                  &\aalt{x}{
                    \asnd{k_P}{c,h} \apar \asnd{k_a}{x,t}
                  }\ 
                }
              \end{aligned}
            }\ 
          }
        \end{aligned}
      \\
      \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
      \\
      \apar  &\arcv{k_a}{f',l''} . \ains{B_a^P}{a}{x, y, f', l'',\tilde{z}_P}
      \\
      \apar  &R_{garbage}
      \ \big)
    \end{aligned}
  }}}}}}}}}
\end{align*}

\TODO{1cm}{$B_{cons}$ receives continuations, $k_c$ received, $k_c, k_n$ to garbage}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{l'}{\anew{k_P}{\anew{k_a}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \ains{B_{cons}}{l'}{b, l}
      \\
      \apar
        &\begin{aligned}[t]
          \acse*{x}{\ 
            &\aalt{x}{
              \begin{aligned}[t]
                \acse*{y}{\ 
                  &\aalt{x}{\anew*{l''}{
                    \ains{B_{cons}}{l''}{c,l'} \apar \asnd{k_a}{x,l''}
                  }}\\
                  &\aalt{y}{
                    \asnd{k_P}{b,c} \apar \asnd{k_a}{x,l}
                  }\ 
                }
              \end{aligned}
            }\\
            &\aalt{y}{
              \begin{aligned}[t]
                \acse*{y}{\ 
                  &\aalt{y}{\anew*{l''}{
                    \ains{B_{cons}}{l''}{c,l'} \apar \asnd{k_a}{x,l''}
                  }}\\
                  &\aalt{x}{
                    \asnd{k_P}{c,b} \apar \asnd{k_a}{x,l}
                  }\ 
                }
              \end{aligned}
            }\ 
          }
        \end{aligned}
      \\
      \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
      \\
      \apar  &\arcv{k_a}{f',l''} . \ains{B_a^P}{a}{x, y, f', l'',\tilde{z}_P}
      \\
      \apar  &R_{garbage}'
      \ \big)
    \end{aligned}
  }}}}}}}
\end{align*}

\TODO{1cm}{cases}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{l'}{\anew{k_P}{\anew{k_a}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \ains{B_{cons}}{l'}{b, l}
      \\
      \apar  &\asnd{k_P}{b,c}
      \apar   \asnd{k_a}{x,l}
      \\
      \apar  &\arcv{k_P}{u,v} . \encMJtoAP{P}
      \\
      \apar  &\arcv{k_a}{f',l''} . \ains{B_a^P}{a}{x, y, f', l'',\tilde{z}_P}
      \\
      \apar  &R_{garbage}'
      \ \big)
    \end{aligned}
  }}}}}}}
\end{align*}

\TODO{1cm}{$k_P$}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{l'}{\anew{k_a}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \ains{B_{cons}}{l'}{b, l}
      \\
      \apar  &\asnd{k_a}{x,l}
      \\
      \apar  &\encMJtoAP{P}\substitution{\subst{b}{u},\subst{c}{v}}
      \\
      \apar  &\arcv{k_a}{f',l''} . \ains{B_a^P}{a}{x, y, f', l'',\tilde{z}_P}
      \\
      \apar  &R_{garbage}'
      \ \big)
    \end{aligned}
  }}}}}}
\end{align*}

\TODO{1cm}{$k_a$}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{\anew{l'}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \apar   \ains{B_{cons}}{l'}{b, l}
      \\
      \apar  &\encMJtoAP{P}\substitution{\subst{b}{u},\subst{c}{v}}
      \\
      \apar  &\ains{B_a^P}{a}{x, y, x, l,\tilde{z}_P}
      \\
      \apar  &R_{garbage}
      \ \big)
    \end{aligned}
  }}}}}
\end{align*}

\TODO{1cm}{substitution, remove $l'$}

\begin{align*}
  &\anew{a}{\anew{x}{\anew{y}{\anew{l}{ \\
    &\hspace{0.5cm}
    \begin{aligned}[t]
      \big(\ &\ains{B_{fw}}{x}{a}
      \apar   \ains{B_{fw}}{y}{a}
      \apar   \encMJtoAP{Q}
      \apar   \ains{B_{nil}}{l}{}
      \\
      \apar  &\encMJtoAP{P\substitution{\subst{b}{u},\subst{c}{v}}}
      \\
      \apar  &\ains{B_a^P}{a}{x, y, x, l,\tilde{z}_P}
      \\
      \apar  &R_{garbage}
      \ \big)
    \end{aligned}
  }}}}
\end{align*}

\TODO{1cm}{has same behavior to following:\\
  (garbage terms are of form $\anew*{x}{\arcv{x}{y} . R}$ and can never interact)}

\begin{align*}
  \encMJtoAP{\jdef{\jrct{\jrcv{x}{u} \jpat \jrcv{y}{v}}{P}}{P\substitution{\subst{b}{u},\subst{c}{v}} \jpar Q}}
  =\ &\anew{a}{\anew{x}{\anew{y}{\anew{l}{ \\
      &\hspace{0.5cm}
      \begin{aligned}[t]
        \big(\ &\ains{B_{fw}}{x}{a}
        \apar   \ains{B_{fw}}{y}{a} \\
        \apar  &\encMJtoAP{P\substitution{\subst{b}{u},\subst{c}{v}}} \apar \encMJtoAP{Q} \\
        \apar  &\ains{B_{nil}}{l}{}
        \apar   \ains{B_a^P}{a}{x, y, x, l, \tilde{z}_P}
        \ \big)
      \end{aligned}
    }}}}
\end{align*}

\TODO{3cm}{turn into proof of completeness?}


\subsection{Full Abstraction}

\TODO{3cm}{join-pi encodings require firewall for full abstraction\\
  (explain why by example?)\\
  this is not necessary here, because ...}
